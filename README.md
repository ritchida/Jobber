# Jobber

Jobber is a Cassandra-backed job reporting service written in Go.

## Development

### Clone the Jobber Repository

The first step in Jobber development is cloning the Jobber repository:

```bash
mkdir -p $GOPATH/src/github.com/ritchida
cd $GOPATH/src/github.com/ritchida
git clone git@github.com:ritchida/Jobber.git
```

### Dependencies

Jobber depends on two go packages, gocql and go-swagger:

```bash
go get github.com/gocql/gocql
go get go get -u github.com/go-swagger/go-swagger/cmd/swagger
```

### Database server

Jobber uses a Cassandra database to store information on jobs.  To setup a VM to run Cassandra (for example, in AWS):

#### Create an Instance in AWS

Sign into AWS and launch an instance as follows:
* Ubuntu 16.04
* Free tier (t2.micro) is fine
* Auto-assign public IP
* Add a 30 GB hard drive
* Add a security group rull to allow ingress for TCP on port 9042
* Specify an SSH keypair that will give you access to the instance

#### Install and Configure Cassandra

When the instance is launched, SSH into using the keypair specified during launch, and install Cassandra following these instructions for Ubuntu 16.04: 

(http://www.itzgeek.com/how-tos/linux/ubuntu-how-tos/install-cassandra-on-ubuntu-16-04-and-run-a-single-node-cassandra-cluster-on-ubuntu.html)

To configure Cassandra to accept connections from other servers, edit the file /etc/cassandra/cassandra.yaml:

* Set the listen_address to the private ip of the Cassandra host
* Set the broadcast_address to the private ip of the Cassandra host
* Set the rpc_address to the private ip of the Cassandra host
* Set the seeds to the private ip of the Cassandra host
* Restart the Cassandra service:
```bash
sudo service cassandra Restart
```
* Check the service status and make sure it is running:
```bash
sudo service cassandra status
```
* Make sure the Cassandra host is listening on port 9042:
```bash
netstat -tulpn
```
Look for something like:
```bash
tcp        0      0 <cassandra server ip>:9042      0.0.0.0:*               LISTEN      -
```
in the response.
* Go back to your development machine, and make sure you can see port 9042 on the Cassandra machine:
```bash
Dans-MacBook-Pro:~ danritchie$ nc -v <public ip of cassandra host> 9042
found 0 associations
found 1 connections:
     1:	flags=82<CONNECTED,PREFERRED>
	outif en0
	src 192.168.41.194 port 50290
	dst 35.163.18.1 port 9042
	rank info not available
	TCP aux info available

Connection to 35.163.18.1 port 9042 [tcp/*] succeeded!
```

### REST API Definition

Jobber uses go-swagger to generate a REST client and server based on a resource definition file (api/swagger.yml).  

To generate the client and server, as well as the Go data structures used to serialize/deserialize data to/from the REST API, run:

```bash
make generate
```
Successive runs of this command require that the swagger-generated files are removed with:
```bash
make clean-generated
```

### Jobber Service

The server code generated by go-swagger was used as the basis for the Jobber service.  The main function for the Jobber service is defined in cmd/jobber/main.go.  

As new APIs are added to the swagger doc, corresponding handlers will be generated, and their initialization must be manually added to the service configuration in cmd/jobber/restapi/configure_jobber.go.

To run the Jobber service as a background task:
```bash
go run cmd/jobber/main.go&
```
This will return the process ID of one process, but will also start another process.  To terminate both processes:
```bash
ps aux | grep "command-line-arguments/_obj/exe/main" | grep -v grep | awk '{print $2}' | xargs kill -9
```

By default, the server listens on 127.0.0.1:9090.  You can configure the host:port that the servier listens on by setting the following environment variables:
```bash
export JOBBER_HOST=<host/ip of jobber server>
export JOBBER_PORT=<port number of jobber server>
```

To run the integration tests you must have an instance of Cassandra running and publicly-accessible.
Once you have an instance/cluster running, set the CASSANDRA_CLUSTER_IPS environment variable:
```bash
export CASSANDRA_CLUSTER_IPS=<public ip of cassandra node>
```
Then you can run all of the existing Cassandra integration tests (Database and API):
```bash
make test
```

### Adding Functionality

To add APIs to the Jobber service, execute the following steps:

* Add any database tables necessary following the conceptual, logical, physical data modelling guidelines for Cassandra
* Modify the the repository in pkg repository jobber_repository.go and pkg/repository/cassandra_jobber.go as necessary to support querying Cassandra
* Add integration tests to pkg/repository/cassandra_jobber_test.go
* To run the database tests:
```bash
make repo-test
```
* Modify the api/swagger.yml file as necessary to support your new API(s)
* make clean
* make generate
* Add an internal representation of your generated API objects in pkg/models, and a mapping between the API and the internal representation
* Add a handler to cmd/jobber/handler to invoke the repository and return data/error to the API as appropriate
* Initialize the service with your handler in cmd/jobber/restapi/configure_jobber.go
* Add appropriate API integration tests to cmd/jobber/restapi/jobber_api_test.go
* Run the API integration tests:
```bash
make test-api
```
